# Azure DevOps Pipeline para TikTask
# Ejecuta tests automáticamente en cada push/PR

trigger:
  - main
  - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  NODE_VERSION: '18.x'

stages:
  - stage: Build_and_Test
    displayName: 'Build and Test'
    jobs:
      - job: RunTests
        displayName: 'Run Unit and Integration Tests'
        steps:
          # 1. Checkout del código
          - checkout: self
            displayName: 'Checkout repository'

          # 2. Configurar Node.js
          - task: NodeTool@0
            inputs:
              versionSpec: $(NODE_VERSION)
            displayName: 'Install Node.js $(NODE_VERSION)'

          # 3. Instalar dependencias
          - script: |
              npm ci
            displayName: 'npm install'

          # 4. Ejecutar tests con cobertura
          - script: |
              npm run test:ci
            displayName: 'Run tests with coverage'
            env:
              NODE_ENV: test

          # 5. Publicar resultados de tests
          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            condition: succeededOrFailed()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/test-results/junit.xml'
              searchFolder: '$(System.DefaultWorkingDirectory)'
              mergeTestResults: true
              failTaskOnFailedTests: true
              testRunTitle: 'TikTask Tests - $(Build.BuildNumber)'

          # 6. Publicar cobertura de código
          - task: PublishCodeCoverageResults@2
            displayName: 'Publish Code Coverage'
            condition: succeededOrFailed()
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage/cobertura-coverage.xml'
              reportDirectory: '$(System.DefaultWorkingDirectory)/coverage'
              failIfCoverageEmpty: false

          # 7. Publicar artefactos (opcional)
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Artifacts'
            condition: succeeded()
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'drop'
              publishLocation: 'Container'